- page = local_assigns.fetch(:page)
- image = local_assigns.fetch(:image)
- details = local_assigns.fetch(:details, true)
- buyable = local_assigns.fetch(:buyable, true)
- display_styles = local_assigns.fetch(:styles, true)
- photo = local_assigns.fetch(:photo, false)
- close_url = local_assigns[:close_url]
- previous_page_url = local_assigns[:previous_page_url]
- next_page_url = local_assigns[:next_page_url]

- cache [I18n.locale, page, *@parents, image, image.author, :lightbox, details, display_styles, photo, buyable, previous_page_url, next_page_url, close_url] do
  #nav_lightbox_xs.container.visible-xs
    = link_to :root, id: 'brand' do
      = image_tag 'logo.png', id: 'logo', alt: 'GTGRAPHICS'
      .sr-only GTGRAPHICS
    = render 'navbar', back_url: close_url

  - present page do |page|
    - present image do |image|
      %nav.navbar.navbar-lightbox#navbar_lightbox.hidden-xs{role: 'navigation'}
        .container-fluid
          = link_to :root, id: 'lightbox_brand', class: 'navbar-brand hidden-xs' do
            = image_tag 'lightbox_logo.png', id: 'logo', alt: 'GTGRAPHICS'
            %span.sr-only GTGRAPHICS

          #nav_lightbox_controls
            - if close_url
              %ul#nav_close.nav.navbar-nav.navbar-right
                %li
                  = link_to close_url, id: 'lightbox_close', title: translate('helpers.links.close'), data: { toggle: 'tooltip', placement: 'bottom' } do
                    = close
                    %span.sr-only= translate('helpers.links.close')

            %ul#nav_lightbox_actions.nav.navbar-nav.navbar-right
              - if details
                %li.enlarge-image.hidden-sm.js-only
                  = link_to '#top', title: translate('helpers.links.enlarge_image'), accesskey: 'p', data: { scroll: true, toggle: 'tooltip', placement: 'bottom' } do
                    = icon :search_plus, size: :lg, fixed_width: true
                    %span.sr-only= translate('helpers.links.enlarge_image')

                %li.info.hidden-sm.js-only
                  = link_to '#info', title: translate('helpers.links.details'), accesskey: 'i', data: { toggle: 'tooltip', placement: 'bottom' } do
                    = icon :info, size: :lg, fixed_width: true, style: :circle
                    %span.sr-only= translate('helpers.links.details')

                %li.comment.hidden-sm.js-only
                  = link_to '#comments', title: translate('helpers.links.comment'), accesskey: 'c', data: { scroll: true, toggle: 'tooltip', placement: 'bottom' } do
                    = icon :comment, size: :lg, fixed_width: true
                    %span.sr-only= translate('helpers.links.comment')

              - if display_styles && (@image_styles.any? || @image_downloads.any?)
                %li.dropdown.hidden-sm.js-only
                  = link_to '#', id: 'image_download_dropdown', title: translate('helpers.links.download'), class: 'dropdown-toggle', :'aria-haspopup' => 'true', data: { toggle: 'dropdown' } do
                    = icon :download, size: :lg, fixed_width: true
                    = caret
                    %span.sr-only= translate('helpers.links.download')
                  %ul.dropdown-menu{role: 'menu', :'aria-labelledby' => 'image_download_dropdown'}
                    - present_collection(@image_styles).each do |style|
                      %li= link_to style.title, current_page_path(:download_image, format: style.format, style_id: style.position), class: 'download', data: { no_turbolink: true }
                    - if @image_styles.any? && @image_downloads.any?
                      %li.divider
                    - present_collection(@image_downloads).each do |download|
                      %li
                        = link_to download.url, data: { no_turbolink: true } do
                          .download-title= download.title
                          .download-details
                            %small.weak= download.content_type

              - if buyable
                %li.dropdown.hidden-sm
                  - if image.shop_urls.each_value.any?(&:present?)
                    = link_to image.shop_url('gtgraphics'), title: translate('helpers.links.buy'), id: 'image_buy_dropdown', class: 'dropdown-toggle', :'aria-haspopup' => 'true', data: { toggle: 'dropdown' } do
                      = icon :shopping_cart, size: :lg, fixed_width: true
                      = caret
                      %span.sr-only= translate('helpers.links.buy')
                    %ul.dropdown-menu.shop-providers{role: 'menu', :'aria-labelledby' => 'image_buy_dropdown'}
                      = image.shop_links
                  - else
                    = link_to image.shop_url('gtgraphics'), title: translate('helpers.links.buy'), data: { toggle: 'tooltip', placement: 'bottom' } do
                      = icon :shopping_cart, size: :lg, fixed_width: true
                      %span.sr-only= translate('helpers.links.buy')

            - if details
              #nav_lightbox_social_buttons.js-only
                %ul.clearfix.hidden-xs.hidden-sm
                  %li.facebook-like= page.facebook_like_button(share_button: true)
                  %li.twitter-share= page.twitter_share_button
                  %li.pinterest-share= page.pinterest_share_button
                  %li.google-plus-one= page.google_plus_like_button

      #lightbox{class: ['lightbox', details ? 'lightbox-with-details' : 'lightbox-without-details']}
        .lightbox-image-container
          .lightbox-background.hidden-xs.hidden-sm{style: background_css(attached_asset_path(@image, :brick))}
          %figure.lightbox-image{style: background_css(attached_asset_path(@image, :public))}
            = image_tag attached_asset_path(@image, :public), width: @image.width, height: @image.height, alt: @image.title
            %figcaption.sr-only
              = image.description

        .lightbox-controls
          - if previous_page_url
            = link_to previous_page_url, class: 'lightbox-control left', role: 'button', data: { hotkey: 'left' } do
              = icon :chevron, direction: :left
              %span.sr-only= translate('helpers.links.previous')

          - if next_page_url
            = link_to next_page_url, class: 'lightbox-control right', role: 'button', data: { hotkey: 'right' } do
              = icon :chevron, direction: :right
              %span.sr-only= translate('helpers.links.next')

      - if details
        #lightbox_content_wrapper
          #lightbox_page_wrapper
            #lightbox_page_content.container
              #info
                %a{name: 'info'}

                .page-header.lightbox-title.clearfix
                  %h1= image.title

                  #social_buttons.btn-toolbar.js-only
                    .facebook-like.btn-group.hidden-md.hidden-lg
                      = page.facebook_like_button(share_button: true)
                    .twitter-share.btn-group.hidden-md.hidden-lg
                      = page.twitter_share_button
                    .pinterest-share.btn-group.hidden-md.hidden-lg
                      = page.pinterest_share_button
                    .google-plus-one.btn-group.hidden-md.hidden-lg
                      = page.google_plus_like_button

                .page-body
                  .info-bar
                    %ul.list-info-bar
                      %li.author
                        = image.author.info
                      - if @parents.present?
                        %li.image-type.hidden-xs
                          = link_to @parents.last do
                            = prepend_icon :tag, @parents.map(&:title).join(icon(:angle, fixed_width: true, direction: :right)).html_safe, fixed_width: true
                      %li.taken-at
                        = prepend_icon :clock, image.taken_at, outline: true, fixed_width: true

                  - if image.description.present?
                    .lightbox-caption
                      .lightbox-description
                        = image.description

                  - if photo
                    .lightbox-metadata.row
                      .col-md-6.lightbox-metadata-column
                        = image.attribute_list :camera, :lens_model, :iso_value
                      .col-md-6.lightbox-metadata-column
                        = image.attribute_list :exposure_time, :focal_length, :f_number

                .page-body.visible-xs.visible-sm
                  .row
                    - if image.shop_links.present?
                      / Buy
                      .col-xs-12.col-sm-6
                        %h3= prepend_icon :shopping_cart, translate('helpers.links.buy'), fixed_width: true
                        %ul.list-unstyled.shop-providers
                          = image.shop_links

                    - if display_styles && (@image_styles.any? || @image_downloads.any?)
                      .col-xs-12.col-sm-6
                        / Downloadable Styles
                        %h3= prepend_icon :download, translate('helpers.links.download'), fixed_width: true

                        - if @image_styles.any?
                          %ul.list-unstyled.image-styles
                            - present_collection(@image_styles).each do |style|
                              %li= link_to style.title, current_page_path(:download_image, format: style.format, style_id: style.position), data: { no_turbolink: true }

                        - if @image_downloads.any?
                          %ul.list-unstyled.image-downloads
                            - present_collection(@image_downloads).each do |download|
                              %li
                                = link_to attachment_path(download.attachment, locale: nil), data: { no_turbolink: true } do
                                  #{download.title} (#{download.content_type})

              / Comments
              .page-body.lightbox-comments.js-only#comments
                %a{name: 'comments'}
                = page.facebook_comments
