# TODO Major Refactoring

queryRemoveButtonState = ($tabs) ->
  disabled = $tabs.find('.translation-tab.translation-available').length <= 1
  $tabs.find('.remove-translation').prop('disabled', disabled)

queryAddButtonStates = ($tabs) ->
  $addableItems = $tabs.find('.add-translation')
  $addableItems.each ->
    $item = $(@).closest('li')
    if translationAdded($tabs, $item.data('locale'))
      $item.addClass('disabled')
    else
      $item.removeClass('disabled')

queryState = ($tabs) ->
  queryRemoveButtonState($tabs)
  queryAddButtonStates($tabs)

translationAdded = ($tabs, locale) ->
  added = false
  $tabs.find('.translation-tab.translation-available').each ->
    if $(@).data('locale') == locale
      added = true
      return false
  added

initAvailableTabs = ($tabs) ->
  $target = $('#translations')

  definedLocales = []
  $target.find('.tab-pane[data-locale]').each ->
    $tabPane = $(@)
    definedLocales.push($tabPane.data('locale'))

  $tabs.find('.translation-tab').each ->
    $tab = $(@)
    locale = $tab.data('locale')
    if jQuery.inArray(locale, definedLocales) >= 0
      $tab.show()
      $tab.addClass('translation-available').removeClass('translation-unavailable')
    else
      $tab.hide()
      $tab.removeClass('translation-available').addClass('translation-unavailable')

  $availableTranslationTabs = $('.translation-tab.translation-available')
  if $availableTranslationTabs.filter('.active').length == 0
    locale = $availableTranslationTabs.first().data('locale')
    $tabs.find(".translation-tab[data-locale='#{locale}'] a").tab('show')

createTranslation = ($tabs, locale, callback) ->
  $target = $('#translations')
  $tabPane = $target.find(".tab-pane[data-locale='#{locale}']")
  translationLoaded = $tabPane.length > 0
  if translationLoaded
    $tabs.find(".translation-tab[data-locale='#{locale}'] a").tab('show')    
    $tabPane.find(".destroy-translation").val(false)
    # TODO add existing _destroy hidden field in pane to false!!!

    callback() if callback
  else
    # Fixme - Remove Temp Fix
    #$tabPane = $('<div />', id: locale, class: 'tab-pane', 'data-locale': locale)
    #$tabPane.appendTo($target)

    # TODO: Add HTML via AJAX or re-show already loaded container
    console.log 'load via ajax......'

    url = $tabs.data('url')
    jQuery.ajax
      url: url,
      type: 'get',
      data: { translated_locale: locale },
      dataType: 'html',
      success: (html) ->
        $tabPane = $(html).appendTo($target)
        $tabPane.find('.editor').editor()
        callback() if callback
      error: ->
        # TODO

    #window.setTimeout callback, 4000 # TODO Placeholder
    #callback() if callback

$(document).ready ->
  $('#translations_tabs').each ->
    $tabs = $(@)
    initAvailableTabs($tabs)
    queryState($tabs)

    # Tab Actions
    $tabs.find('.translation-tab a').click (event) ->
      #return unless event.currentTarget == @
      event.preventDefault()
      $link = $(@)
      $tab = $link.closest('.translation-tab')
      unless $tab.hasClass('disabled')
        $link.tab('show')

    # Remove Translation
    $tabs.on 'click', '.remove-translation', (event) ->
      #return unless event.currentTarget == @
      event.preventDefault()
      event.stopPropagation()
      $(document).click() # closes all dropdowns

      $link = $(@)
      $tab = $link.closest('.translation-tab')
      if $tab.hasClass('active')
        $tab.siblings('.translation-tab').first().find('a').tab('show') 
      $tab.hide().removeClass('translation-available')
      $link.tooltip('hide') # dirty fix

      locale = $tab.data('locale')

      $tabPane = $("#translations .tab-pane[data-locale='#{locale}']")
      $tabPane.find(".destroy-translation").val(true)

      queryState($tabs)

    # Add Translation
    $tabs.find('.add-translation').click (event) ->
      event.preventDefault()
      $link = $(@)
      $dropdownItem = $link.closest('li')
      unless $dropdownItem.hasClass('disabled')
        locale = $link.data('locale')

        $dropdownItem.addClass('disabled')

        # Show new Tab
        $tab = $tabs.find(".translation-tab[data-locale='#{locale}']")
        $tab.show().addClass('translation-available')

        # Replace Flag With Loader
        $flag = $tab.find('.flag')
        flagIconSrc = $flag.attr('src')
        loaderSrc = "<%= asset_path('admin/loader.gif') %>"
        $flag.attr('src', loaderSrc)
        $tab.removeClass('active')
        $tab.addClass('disabled')

        # Load Translation Tab
        createTranslation $tabs, locale, ->
          console.log 'complete'

          $flag.attr('src', flagIconSrc)
          $tab.removeClass('disabled')

          # view tab after it has been created/found
          $tabs.find(".translation-tab[data-locale='#{locale}'] a").tab('show')

          queryState($tabs)